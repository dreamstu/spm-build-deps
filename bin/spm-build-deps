#!/usr/bin/env node

var path = require('path');
var commander = require('commander');
var color = require('colorful').color;
var fs = require('fs');
require("shelljs/global");
//var exec = require("child_process").exec;

var DEFAULT_SRC_DIR = "sea-modules";
var DEFAULT_DEST_DIR = "cmd-modules";

var pkg = require("../package.json");
var spmrc = require("spmrc");
var mkdirp = require("mkdirp");


commander
  .version(pkg.version)
  .usage('[locale]')
  .option('-v, --verbose', 'Show more infomation.')
  .option('-s, --src [source]', 'Specify build input source directory.')
  .option('-d, --dest [destination]', 'Specify build output dest directory.')
  .option('-f, --force', 'Force to process the task.');

commander.on('--help', function() {
  console.log();
  console.log('  Change locale directory in ~/.spm/spmrc');
  console.log();
  console.log(color.magenta('    [deps-build]'));
  console.log('    default-destination = cmd-modules');
  console.log();
});
commander.parse(process.argv);


var project_dir = process.cwd();
var pkg_file = project_dir + '/package.json';
if(!fs.existsSync(pkg_file)){
  console.error("Not found package.json");
  return;
}
var module_pkg = require(pkg_file);

var src_dir = commander.src || spmrc.get("deps.src") || DEFAULT_SRC_DIR;
var dest_dir = commander.dest || spmrc.get("deps.dest") || DEFAULT_DEST_DIR;
var dependencies = [];

if (!module_pkg || !module_pkg.spm){
  console.error("No package or spm infomation found.");
  return;
}

function find_deps(deps){
  if(!deps){return;}

  for(var depsName in deps){
    if(!deps.hasOwnProperty(depsName)){continue;}

    var depsVersion = deps[depsName];

    if(!commander.force &&
        fs.existsSync(
          project_dir + "/" + dest_dir + "/" + depsName + "/" + depsVersion
        )
      ){
        continue;
    }

    var sub_pkg_file = project_dir + "/" + src_dir + "/" + depsName + "/" +
        depsVersion + "/package.json";

    if(!fs.existsSync(sub_pkg_file)){
      continue;
    }

    var deps_module_pkg = require(sub_pkg_file);

    if(!deps_module_pkg || !deps_module_pkg.spm){
      continue;
    }

    dependencies.push({
      name: depsName,
      version: depsVersion
    });

    find_deps(deps_module_pkg.spm.dependencies);
    find_deps(deps_module_pkg.spm.devDependencies);
    // Note: Engines build via seatools.
    //find_deps(deps_module_pkg.spm.engines);

  }
}

find_deps(module_pkg.spm.dependencies);
find_deps(module_pkg.spm.devDependencies);
// Note: Engines build via seatools.
//find_deps(module_pkg.spm.engines);

var cache_deps = {};
dependencies = dependencies.filter(function(deps){
  var key = deps.name + "@" + deps.value;
  if(cache_deps.hasOwnProperty(key)){
    return false;
  }
  cache_deps[key] = key;
  return true;
});


function build(module_dir, dest_dir){
  if(!fs.existsSync(module_dir)){
    console.log(color.red("No found dir: " + module_dir));
    return;
  }

  fs.stat(module_dir, function(err, stats){
    if(err){
      return console.log(color.red("Read module dir [" + module_dir + "] error: ", err));
    }
    if(stats.isDirectory()){
      cd(module_dir);
      exec("spm build -O " + dest_dir, function(error, stdout, stderr){

        if(error){
          console.log("");
        }else{
        }

      });
    }
  })
}


for(var i=0,l=dependencies.length; i<l; i++){
  var depsName = dependencies[i].name;
  var depsVersion = dependencies[i].version;
  build(
    project_dir + "/" + src_dir +
      "/" + depsName + "/" + depsVersion,
    project_dir + "/" + dest_dir
  );
}


// vim:ft=javascript
